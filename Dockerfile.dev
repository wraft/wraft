FROM hexpm/elixir:1.15.8-erlang-25.2.3-debian-bookworm-20240722

RUN apt-get update && \
    apt-get install -y \
    postgresql-client inotify-tools

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
    build-essential xorg libssl-dev libxrender-dev git wget gdebi xvfb \
    wkhtmltopdf \
    texlive-fonts-recommended \
    texlive-plain-generic \
    texlive-latex-extra \
    texlive-xetex \
    imagemagick

RUN wget https://github.com/jgm/pandoc/releases/download/3.6.3/pandoc-3.6.3-1-arm64.deb \
    && dpkg -i pandoc-3.6.3-1-arm64.deb \
    && rm pandoc-3.6.3-1-arm64.deb

# Install Typst
RUN wget -q https://github.com/typst/typst/releases/download/v0.13.0/typst-x86_64-unknown-linux-musl.tar.xz && \
    tar -xf typst-x86_64-unknown-linux-musl.tar.xz && \
    mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/typst && \
    rm -rf typst-x86_64-unknown-linux-musl typst-x86_64-unknown-linux-musl.tar.xz

RUN echo "xvfb-run -a -s \"-screen 0 640x480x16\" wkhtmltopdf \"\$@\"" >/usr/local/bin/wkhtmltopdf-wrapper && chmod +x /usr/local/bin/wkhtmltopdf-wrapper


WORKDIR /app
COPY config /app/config
COPY lib /app/lib
COPY mix.exs mix.lock /app/
COPY priv priv
COPY assets assets

ARG SECRET_KEY_BASE
ARG SELF_HOSTED

# only for dev
COPY entrypoint_dev.sh /app/
RUN chmod +x /app/entrypoint_dev.sh

RUN mix local.hex --force && \
    mix local.rebar --force && \
    mix deps.get

RUN mix do compile

EXPOSE 4000
CMD ["bash", "/app/entrypoint_dev.sh"]
